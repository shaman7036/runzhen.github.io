---
layout: post
comments: no
title: "TLS Perfect Forward Secrecy 之 DH/ECDHE"
category: Security 
tags: [RSA, ECDHE, DHE, cryption]
---

接着上一篇 [TLS Perfect Forward Secrecy 之 RSA 缺陷](/2017/02/ssl-perfect-forward-secrecy/) 继续来看看 DH/ECDHE 如何解决这个问题.

首先来看一下 DH 算法的数学基础。

```
+-------------------------------------------------------------------+
|                    Global Pulic Elements                          |
|                                                                   |
|       p                               prime number                |
|       a                               prime number, a < p         |
+-------------------------------------------------------------------+
+-------------------------------------------------------------------+
|                    User A Key Generation                          |
|                                                                   |
|       Select private Xa               Xa < p                      |
|       Calculate public Ya             Ya = a^Xa mod p             |
+-------------------------------------------------------------------+
+-------------------------------------------------------------------+
|                    User B Key Generation                          |
|                                                                   |
|       Select private Xb               Xb < p                      |
|       Calculate public Yb             Yb = a^Xb mod p             |
+-------------------------------------------------------------------+
+-------------------------------------------------------------------+
|               Calculation of Secret Key by User A                 |
|                                                                   |
|       Secret Key K                    K = Yb^Xa mod p             |
+-------------------------------------------------------------------+
+-------------------------------------------------------------------+
|               Calculation of Secret Key by User B                 |
|                                                                   |
|       Secret Key K                    K = Ya^Xb mod p             |
+-------------------------------------------------------------------+

```

上面一共出现了 a, p, Xa, Ya, Xb, Yb, K 共 7 个数，其中：

* 公开的数：a, p, Ya, Yb    
* 非公开数：Xa, Xb, K    

通常情况下，a 一般为 2 或 5，而 p, Xa 和 Xb 的取值也非常大，其复杂度至少为 `O(p^0.5)`。对于攻击者来说，已知 Ya，Xa 的求解非常困难，同理 Xb 的求解也很困难，所以攻击者难以求出 K，所以 DH 能够保证通信双方在透明的信道中安全的交换密钥。

值得注意的是，*DH 算法本身并没有提供通讯双方的身份验证功能，也就是说 DH 算法会被中间人攻击。* 这时就需要 DSA（数字签名算法）来对传输的数据进行签名，这样使得接受双方可以确认信息的来源。

在握手过程中，client hello 和 server hello 过程都与RSA是一样的，RSA 的第三步是 “client key exchange”，而 ECDHE 的第三步是 “server key exchange”。

**Server Key Exchange** 
server 需要传递几个参数给client，同时，server 也要签发自己的数字签名，以便client 能够校验（验明正身）。在server key exchange 阶段，以上信息会被发给client。

**Client Key Exchange**
client 在收到上一步的信息后，首先验证证书是它想访问的server的，同时也发送自己的参数给server。现在，client 和 server 都拥有了 DH 算法中的3个参数，然后分别计算 pre-master key，然后根据 client random, server random，pre-master key 生成 session key。

![RSA handshake](/image/2017/ssl_handshake_diffie_hellman.png)

以上就是一个粗略版本的 RSA 和 DH 握手过程，而ECDH 是基于ECC（Elliptic Curve Cryptosystems）的 DH 密钥交换算法。ECDH 每次用一个固定的DH key，所以并不支持forward sercecy，支持 forward sercecy 的是 ECDHE 算法或其他版本的ECDH算法。

# ECDHE 的具体过程



参考资料
* https://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details/
* https://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy#diffie-hellman-with-discrete-logarithm
* https://www.zhihu.com/question/54320042
* https://www.acunetix.com/blog/articles/establishing-tls-ssl-connection-part-5/






