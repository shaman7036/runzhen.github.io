---
layout: post
comments: true
title: RFC 793 TCP 协议中文版
category: 协议
tags: [tcp, RFC]
---

FUNCTIONAL SPECIFICATION

###  头部格式

IP 头部带有源地址和目地址等信息，这两者也同样会被 TCP 头部的某些字段使用（比如计算 checksum 的时候）。

TCP 头部格式如下：

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |          Source Port          |       Destination Port        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        Sequence Number                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Acknowledgment Number                      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Data |           |U|A|P|R|S|F|                               |
   | Offset| Reserved  |R|C|S|S|Y|I|            Window             |
   |       |           |G|K|H|T|N|N|                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           Checksum            |         Urgent Pointer        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                             data                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                            TCP Header Format

```

Source Port，16位，源端口号

Destination Port，16位，目的端口号

Sequence Number，32位，序列号。

Acknowledgment Number，32位，确认号。

Data Offset，4位，数据偏移量。通过它可以得出一个 TCP 报文的数据的起始位置，它的单位是32位，也就是以4字节为单位，所以能表示最大值为 `15*4=60`字节，换句话说 TCP 首部长度最大为60字节。（TCP 首部也是4字节对齐的，不满的部分需要 padding）

Reserved，4位，保留未用。

Control Bits:  6位，从左到右分别为
- URG, 紧急指针标志
- ACK，ACK 标志
- PSH，push 标志
- RST，重置标志
- SYN，syn 标志
- FIN，fin 标志

Window，16位，接受窗口大小。指明`发送这个 TCP 报文`的`发送方`接受窗口的大小

Checksum，16位，校验位。包括了 TCP 的首部和数据都在计算校验值的范围内。计算是以 16bit（2字节）为单位进行的，如果 tcp 报文不能被2字节整除，那么要在最后加0作为 padding。计算这个校验值的时候，IP 层的源地址、目的地址、协议类型、TCP 长度几个字段都在计算的范围内。其中 TCP 长度包括头部和数据长度，这个值没有包含在 IP 或者 TCP 报文的头部，而是在计算 checksum 的时候计算出来的。这4个字段加起来一共 96bit，16个字节。如下图所示。

```
                     +--------+--------+--------+--------+
                     |           Source Address          |
                     +--------+--------+--------+--------+
                     |         Destination Address       |
                     +--------+--------+--------+--------+
                     |  zero  |  PTCL  |    TCP Length   |
                     +--------+--------+--------+--------+

```
熟悉 IP 首部的同学会发现，真正的 IP 首部中这4个字段不是像上面这样排列的，只是在计算 checksum 的时候临时构造了一个“伪首部”。


Urgent Pointer，16位，紧急指针。它的值表示以本报文中数据段为起点的偏移量。

Options，可变长度，选项字段。选项在 TCP 首部的最后，以1字节为单位。所有的选项字段在计算 checksum 的时候都计算在内。选项字段可能包含多个选项，它们没有类似2字节的对齐要求（多个选项可以一个接一个开始）。

选项通常有两种格式：

- 单个字节的选项类型
- 一字节类型，一字节选项长度（长度包含类型和长度，也就是 +2 ），然后紧接选项数据。

TCP 必须实现下面几种选线：

|Kind  |   Length  |  Meaning |
|------|-----------|------------|
| 0    |   - | End of option list. |
| 1    |   - | No-Operation.        |
| 2    |   4 | Maximum Segment Size. |


第一种，一字节8位全是0，它只在有选项字段的时候才出现，而且是出现在所有选项的最后，代表结束。 正常情况下（没有选项的情况）不出现。

```
        +--------+
        |00000000|
        +--------+
```


第二种，No-Operation，无操作（不知道它存在的意义），略。


第三种，Maximum Segment Size （MSS），其作用是发送方告诉接收方能接受的最大报文长度。 MSS 只在发起链接的过程中（例如在 SYN 报文）有用，TCP 正常传输数据的时候，及时有这个选项也会被忽略。

```
        +--------+--------+---------+--------+
        |00000010|00000100|   max seg size   |
        +--------+--------+---------+--------+
         Kind=2   Length=4

```


### 术语

































